<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Günlük Görev · KonusKonusabilirsen</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>
    try{
      const token = localStorage.getItem('hk_token');
      if (!token){
        const redirect = encodeURIComponent('/daily.html');
        window.location.replace(`/?auth=1&redirect=${redirect}`);
      }
    }catch{}
  </script>
</head>
<body>
  <header class="container header">
    <a class="brand" href="/" aria-label="KonusKonusabilirsen anasayfa">KonusKonusabilirsen</a>
    <nav class="nav">
      <a href="/account.html">Hesabım</a>
      <a href="/realtime.html" class="btn btn-text">Canlı Demo</a>
    </nav>
  </header>

  <main class="container" style="padding:24px 0 40px; max-width:900px;">
    <div id="toast" class="toast">Seri +1! Tebrikler 🎉</div>
    <div id="daily" class="card challenge-card" style="padding:16px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Günlük Konuşma Görevi</h2>
        <div class="row" style="gap:8px;">
          <a id="dailyStart" href="/realtime.html" class="btn btn-primary">Görevi Başlat</a>
          <button id="dailyDone" class="btn btn-secondary" type="button" style="display:none;">Tamamlandı</button>
          <button id="dailyShuffle" class="btn btn-secondary" type="button">Değiştir</button>
        </div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
        <span class="pill" id="dailyLevel">Seviye: -</span>
        <span class="pill" id="dailyTag">-</span>
      </div>
      <p class="subtle" id="dailyDesc" style="margin:8px 0 0;">Bugün için öneri yükleniyor...</p>
    </div>
  </main>

  <script src="/config.js"></script>
  <script src="/site.js" type="module"></script>
  <script>
    // After site.js populates scenario & level, check completion and wire complete button
    (async () => {
      try{
        const token = localStorage.getItem('hk_token');
        if (!token) return;
        const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/status`, { headers:{ Authorization: `Bearer ${token}` } });
        const j = await r.json();
        const doneBtn = document.getElementById('dailyDone');
        if (j && j.completed){
          if (doneBtn){ doneBtn.style.display='inline-flex'; doneBtn.disabled=true; doneBtn.textContent='Bugün Tamamlandı'; }
          const start = document.getElementById('dailyStart'); if (start){ start.classList.remove('btn-primary'); start.className='btn btn-secondary'; start.textContent='Tekrar Pratik Et'; }
        } else {
          if (doneBtn){
            doneBtn.style.display='inline-flex';
            doneBtn.addEventListener('click', async () => {
              doneBtn.disabled = true; doneBtn.textContent = 'Kaydediliyor...';
              try{
                // scenario id site.js içinde linke yazılıyor; ordan çekelim
                const href = document.getElementById('dailyStart')?.getAttribute('href') || '/realtime.html';
                const sc = new URLSearchParams(href.split('?')[1]||'').get('scenario');
                const rr = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/complete`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ scenarioId: sc || null, minutes: 10 }) });
                const jj = await rr.json();
                if (rr.ok){
                  doneBtn.textContent = 'Bugün Tamamlandı';
                  // Streak toast
                  try{
                    if (jj?.streakIncremented){
                      const t = document.getElementById('toast');
                      if (t){ t.textContent = `Seri +1! (${jj.streakCount} gün)`; t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); }, 2000); }
                    }
                  }catch{}
                } else { doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert(jj?.error || 'Kaydedilemedi'); }
              }catch(e){ doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert('Bağlantı hatası'); }
            });
          }
        }
      }catch{}
    })();
  </script>
</body>
</html>


