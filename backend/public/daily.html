<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Günlük Görev · KonusKonusabilirsen</title>
  <link rel="stylesheet" href="/styles.css?v=2" />
  <script>
    try{
      const token = localStorage.getItem('hk_token');
      if (!token){
        const redirect = encodeURIComponent('/daily.html');
        window.location.replace(`/?auth=1&redirect=${redirect}`);
      }
    }catch{}
  </script>
</head>
<body>
  <script src="/header.js"></script>

  <main class="container" style="padding:24px 0 40px; max-width:900px;">
    <div id="toast" class="toast">Seri +1! Tebrikler 🎉</div>
    <!-- Top summary -->
    <div class="card" style="padding:16px; margin-bottom:12px;">
      <div class="row" style="justify-content:space-between; align-items:center; gap:8px;">
        <div class="row" style="gap:8px; align-items:center;">
          <span class="pill" id="sumStreak">Seri: 0</span>
          <span class="pill" id="sumReset">Yenilenmeye: --</span>
        </div>
        <div class="row" style="gap:10px; align-items:center;">
          <div style="position:relative; width:74px; height:74px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg); width:74px; height:74px;">
              <path d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="#1b2442" stroke-width="4"/>
              <path id="goalArc" d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="url(#g)" stroke-width="4" stroke-dasharray="0,100"/>
              <defs>
                <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%" stop-color="var(--brand)"/>
                  <stop offset="100%" stop-color="var(--neon)"/>
                </linearGradient>
              </defs>
            </svg>
            <div id="goalPct" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:700;">0%</div>
          </div>
          <div>
            <div class="subtle">Günlük hedef</div>
            <div id="goalText" style="font-weight:700;">0/10 dk</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's challenge -->
    <div id="daily" class="card challenge-card" style="padding:16px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Günlük Konuşma Görevi</h2>
        <div class="row" style="gap:8px;">
          <a id="dailyStart" href="/realtime.html" class="btn btn-primary">Görevi Başlat</a>
          <button id="dailyDone" class="btn btn-secondary" type="button" style="display:none;">Tamamlandı</button>
          <button id="dailyShuffle" class="btn btn-secondary" type="button">Değiştir</button>
        </div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
        <span class="pill" id="dailyLevel">Seviye: -</span>
        <span class="pill" id="dailyTag">-</span>
      </div>
      <p class="subtle" id="dailyDesc" style="margin:8px 0 0;">Bugün için öneri yükleniyor...</p>
    </div>

    <!-- Tip of the day -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Bugünün İpucu</h3>
      <p id="tipText" class="subtle" style="margin:0;">Yükleniyor...</p>
    </div>

    <!-- Practice: Shadowing & Pronunciation -->
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px;">
      <div class="card" id="shadowing" style="padding:16px;">
        <h3 style="margin:0 0 6px;">Shadowing</h3>
        <div class="row" style="gap:12px; align-items:flex-start;">
          <select id="dqShSentence" style="flex:1; min-width:200px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);">
            <option>Merhaba, bugün nasılsın?</option>
            <option>Kendimi geliştirmek için her gün pratik yapıyorum.</option>
            <option>Randevum saat üçte, geç kalmak istemiyorum.</option>
          </select>
          <button id="dqShPlay" class="btn btn-secondary" type="button">Dinle</button>
          <button id="dqShRecord" class="btn btn-primary" type="button" style="margin-top:2px;">Tekrar Et</button>
        </div>
        <div id="dqShResult" class="alert alert-info" style="margin-top:10px; display:none;"></div>
      </div>
      <div class="card" id="pronunciation" style="padding:16px;">
        <h3 style="margin:0 0 6px;">Telaffuz Koçu</h3>
        <div class="row" style="gap:8px;">
          <select id="dqPcPair" style="flex:1; min-width:220px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);"></select>
          <button id="dqPcPlay" class="btn btn-secondary" type="button">Örnek</button>
          <button id="dqPcRecord" class="btn btn-primary" type="button">Tekrar Et</button>
        </div>
        <div id="dqPcResult" class="alert alert-info" style="margin-top:10px; display:none;"></div>
      </div>
    </div>

    <!-- Mini streak calendar -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Son 7 Gün</h3>
      <div id="miniCal" class="row" style="gap:8px;">
      </div>
    </div>

    <!-- Journal -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Bugün Öğrendiklerim</h3>
      <textarea id="journalInput" placeholder="Kısa notlar..." style="width:100%; min-height:100px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);"></textarea>
      <div class="row" style="margin-top:8px; gap:8px; align-items:center;">
        <button id="journalSave" class="btn btn-secondary" type="button">Kaydet</button>
        <small id="journalMsg" class="subtle"></small>
      </div>
    </div>
  </main>

  <script src="/config.js"></script>
  <script src="/site.js" type="module"></script>
  <script src="/footer.js"></script>
  <script>
    // After site.js populates scenario & level, check completion and wire complete button + fill summary/tip/calendar/journal
    (async () => {
      try{
        const token = localStorage.getItem('hk_token');
        if (!token) return;
        const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/status`, { headers:{ Authorization: `Bearer ${token}` } });
        const j = await r.json();
        const doneBtn = document.getElementById('dailyDone');
        if (j && j.completed){
          if (doneBtn){ doneBtn.style.display='inline-flex'; doneBtn.disabled=true; doneBtn.textContent='Bugün Tamamlandı'; }
          const start = document.getElementById('dailyStart'); if (start){ start.classList.remove('btn-primary'); start.className='btn btn-secondary'; start.textContent='Tekrar Pratik Et'; }
        } else {
          if (doneBtn){
            doneBtn.style.display='inline-flex';
            doneBtn.addEventListener('click', async () => {
              doneBtn.disabled = true; doneBtn.textContent = 'Kaydediliyor...';
              try{
                // scenario id site.js içinde linke yazılıyor; ordan çekelim
                const href = document.getElementById('dailyStart')?.getAttribute('href') || '/realtime.html';
                const sc = new URLSearchParams(href.split('?')[1]||'').get('scenario');
                const rr = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/complete`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ scenarioId: sc || null, minutes: 10 }) });
                const jj = await rr.json();
                if (rr.ok){
                  doneBtn.textContent = 'Bugün Tamamlandı';
                  // Streak toast
                  try{
                    if (jj?.streakIncremented){
                      const t = document.getElementById('toast');
                      if (t){ t.textContent = `Seri +1! (${jj.streakCount} gün)`; t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); }, 2000); }
                    }
                  }catch{}
                } else { doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert(jj?.error || 'Kaydedilemedi'); }
              }catch(e){ doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert('Bağlantı hatası'); }
            });
          }
        }
      }catch{}
      // Summary band
      try{
        const token = localStorage.getItem('hk_token');
        if (token){
          const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/status`, { headers:{ Authorization: `Bearer ${token}` } });
          const j = await r.json();
          const sumStreak = document.getElementById('sumStreak');
          const sumReset = document.getElementById('sumReset');
          const goalText = document.getElementById('goalText');
          const goalArc = document.getElementById('goalArc');
          const goalPct = document.getElementById('goalPct');
          const goal = Number(j.goal || 10);
          // usage for today from /usage
          try{
            const ur = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/usage`, { headers:{ Authorization: `Bearer ${token}` } });
            const uj = await ur.json();
            const used = Number(uj.usedDaily || uj.daily?.used || 0);
            const pct = Math.max(0, Math.min(100, Math.round((used/Math.max(1,goal))*100)));
            if (goalText) goalText.textContent = `${used.toFixed(1)}/${goal} dk`;
            if (goalPct) goalPct.textContent = `${pct}%`;
            if (goalArc) goalArc.setAttribute('stroke-dasharray', `${pct},100`);
          }catch{}
          if (sumStreak) sumStreak.textContent = `Seri: ${j.streak || 0}`;
          try{
            const resetAt = j.resetAt ? new Date(j.resetAt) : null;
            function upd(){
              if (!resetAt) return;
              const diff = Math.max(0, resetAt - new Date());
              const h = String(Math.floor(diff/3600000)).padStart(2,'0');
              const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
              if (sumReset) sumReset.textContent = `Yenilenmeye: ${h}:${m}`;
            }
            upd(); setInterval(upd, 60000);
          }catch{}
        }
      }catch{}

      // Tip of the day
      try{
        const tips = [
          'Cümle sonunda düşen tonlama yerine son kelimeyi net vurgula.',
          'Dolgu sözcükleri (şey, yani) yerine kısa duraksama tercih et.',
          'Uzun cümleyi ikiye böl: netlik ve ritim artar.',
          'Telaffuz: /r/leri belirgin ama abartısız yap.',
          'Vurgu: bilgi veren kelimeye hafif vurgu ekle.'
        ];
        const tip = tips[Math.floor(Math.random()*tips.length)];
        const tipEl = document.getElementById('tipText'); if (tipEl) tipEl.textContent = tip;
      }catch{}

      // Mini calendar using journal keys
      try{
        const mini = document.getElementById('miniCal');
        if (mini){
          const token = localStorage.getItem('hk_token');
          let completedSet = new Set();
          if (token){
            try{
              const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/journal`, { headers:{ Authorization: `Bearer ${token}` } });
              const j = await r.json();
              const items = j.items || {};
              completedSet = new Set(Object.keys(items));
            }catch{}
          }
          mini.innerHTML = '';
          for (let i=6;i>=0;i--){
            const d = new Date(); d.setDate(d.getDate()-i);
            const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
            const key = `${y}-${m}-${dd}`;
            const on = completedSet.has(key);
            const dot = document.createElement('div');
            dot.style.width = '14px'; dot.style.height = '14px'; dot.style.borderRadius = '999px';
            dot.style.border = '1px solid #243055';
            dot.style.background = on ? 'linear-gradient(135deg, var(--brand), var(--neon))' : '#0e1430';
            dot.title = key + (on ? ' ✓' : '');
            mini.appendChild(dot);
          }
        }
      }catch{}

      // Journal save
      try{
        const btn = document.getElementById('journalSave');
        if (btn){
          btn.addEventListener('click', async () => {
            const token = localStorage.getItem('hk_token');
            const note = document.getElementById('journalInput')?.value || '';
            const msg = document.getElementById('journalMsg'); if (msg) msg.textContent = 'Kaydediliyor...';
            try{
              const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/journal`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ note }) });
              const j = await r.json();
              if (r.ok){ if (msg) msg.textContent='Kaydedildi.'; }
              else { if (msg) msg.textContent = j?.error || 'Hata'; }
            }catch(e){ if (msg) msg.textContent = 'Bağlantı hatası'; }
          });
        }
      }catch{}

      // Quick warmups (language-aware)
      try{
        // Kullanıcının öğrenilen dilini ve seviyesini /me'den çek
        let learnLang = 'tr';
        let level = 'A2';
        try{
          const token = localStorage.getItem('hk_token');
          if (token){ const mr = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/me`, { headers:{ Authorization: `Bearer ${token}` } }); if (mr.ok){ const me = await mr.json(); learnLang = me?.user?.preferredLearningLanguage || 'tr'; level = me?.user?.placementLevel || level; } }
        }catch{}

        // Dil bazlı gövde içerikleri
        function canonLang(l){ const s=String(l||'en').toLowerCase(); if (s.startsWith('tr')) return 'tr'; if (s.startsWith('en')) return 'en'; return s.split('-')[0]||'en'; }
        async function loadShadowingPool(lang, lvl){
          const code = canonLang(lang);
          async function fetchFirst(urls){
            for (const u of urls){
              try{ const r = await fetch(u, { cache:'no-cache' }); if (r.ok) return r.json(); }catch{}
            }
            return null;
          }
          let data = await fetchFirst([`/shadowing_${code}.json`, `/shadowing-pools/${code}.json`]);
          if (!data && code !== 'en'){
            data = await fetchFirst([`/shadowing_en.json`, `/shadowing-pools/en.json`]);
          }
          const key = ['A1','A2','B1','B2','C1'].includes(lvl)?lvl:'A2';
          const arr = (data && Array.isArray(data[key])) ? data[key] : [];
          return arr;
        }
        async function fillShadowingOptions(){
          const list = await loadShadowingPool(learnLang, level);
          const sample = [...list].sort(()=>Math.random()-0.5).slice(0, Math.min(10, list.length||10));
          if (qSel){ qSel.innerHTML = ''; sample.forEach(s => { const opt=document.createElement('option'); opt.textContent=s; qSel.appendChild(opt); }); }
        }

        // Shadowing
        const qPlay = document.getElementById('dqShPlay');
        const qRec = document.getElementById('dqShRecord');
        const qSel = document.getElementById('dqShSentence');
        const qRes = document.getElementById('dqShResult');
        // Seçenekleri öğrenilen dile göre doldur
        try{ await fillShadowingOptions(); }catch{}
        function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang=(learnLang||'tr'); speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
        async function recognize(ms=3500){ return new Promise((resolve)=>{ try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ resolve(null); return; } const r=new SR(); r.lang=(learnLang||'tr'); r.interimResults=false; r.maxAlternatives=1; r.onresult=e=>resolve(e.results[0][0].transcript||''); r.onerror=()=>resolve(null); r.start(); setTimeout(()=>{ try{ r.stop(); }catch{} }, ms); }catch{ resolve(null); } }); }
        function norm(s){ return (s||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,'').replace(/\s+/g,' ').trim(); }
        if (qPlay){ qPlay.addEventListener('click', ()=> speak(qSel.value)); }
        if (qRec){ qRec.addEventListener('click', async ()=>{ qRes.style.display='block'; qRes.className='alert alert-info'; qRes.textContent='Tekrar edin...'; const hyp=await recognize(3800); if (hyp===null){ qRes.className='alert alert-error'; qRes.textContent='Tarayıcınız konuşma tanımayı desteklemiyor veya izin verilmedi.'; return; } const ref=norm(qSel.value); const got=norm(hyp||''); const rset=new Set(ref.split(' ')); const gset=new Set(got.split(' ')); let inter=0; rset.forEach(w=>{ if(gset.has(w)) inter++; }); const score=Math.round((inter/(new Set([...rset,...gset]).size||1))*100); qRes.className= score>70?'alert alert-success':(score>40?'alert alert-info':'alert alert-error'); qRes.textContent=`Eşleşme skoru: %${score} — “${got||'—'}”`; }); }

      // Pronunciation mini (kelime tabanlı minimal çiftler)
      const pPlay = document.getElementById('dqPcPlay');
      const pRec = document.getElementById('dqPcRecord');
      const pSel = document.getElementById('dqPcPair');
      const pRes = document.getElementById('dqPcResult');
      let __pronPairs = [];
      async function loadPronPairs(lang){
        function canon(l){ const s=String(l||'en').toLowerCase(); if (s.startsWith('tr')) return 'tr'; if (s.startsWith('en')) return 'en'; return s.split('-')[0]||'en'; }
        const code = canon(lang);
        async function tryFetch(u){ try{ const r=await fetch(u, { cache:'no-cache' }); if (r.ok) return await r.json(); }catch{} return null; }
        let data = await tryFetch(`/pronunciation_${code}.json`);
        if (!data && code!=='en') data = await tryFetch(`/pronunciation_en.json`);
        if (data && Array.isArray(data.pairs)) return data.pairs;
        // Güvenli yedek: İngilizce minimal çiftler
        return [
          {a:'pat', b:'bat', hint:'p vs b'},
          {a:'ship', b:'sheep', hint:'ɪ vs iː'},
          {a:'full', b:'fool', hint:'ʊ vs uː'},
          {a:'light', b:'right', hint:'l vs r'},
          {a:'thin', b:'then', hint:'θ vs ð'},
          {a:'seat', b:'sit', hint:'iː vs ɪ'},
          {a:'cat', b:'cut', hint:'æ vs ʌ'},
          {a:'cheap', b:'jeep', hint:'tʃ vs dʒ'}
        ];
      }
      function fillPronOptions(){
        if (!pSel) return;
        pSel.innerHTML='';
        __pronPairs.forEach((p,i)=>{
          const opt=document.createElement('option');
          opt.value=String(i);
          opt.textContent = `${p.a} ↔ ${p.b}${p.hint?` (${p.hint})`:''}`;
          pSel.appendChild(opt);
        });
      }
      function currentPair(){ const idx = Number(pSel?.value||0); return __pronPairs[idx] || __pronPairs[0]; }
      if (pPlay){ pPlay.addEventListener('click', ()=>{ const pr=currentPair(); if(!pr) return; speak(pr.a); setTimeout(()=>speak(pr.b), 500); }); }
      function editDistance(a,b){ const s=(a||'').toLowerCase(); const t=(b||'').toLowerCase(); const m=s.length, n=t.length; const dp=Array.from({length:m+1}, ()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost=s[i-1]===t[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); } } return dp[m][n]; }
      function sim(a,b){ const ed=editDistance(a,b); const M=Math.max(1, Math.max(String(a||'').length, String(b||'').length)); return Math.round((1 - ed/M)*100); }
      if (pRec){ pRec.addEventListener('click', async ()=>{
        pRes.style.display='block'; pRes.className='alert alert-info'; pRes.textContent='Tekrar edin...';
        const hyp=await recognize(3800);
        if (hyp===null){ pRes.className='alert alert-error'; pRes.textContent='Tarayıcınız konuşma tanımayı desteklemiyor veya izin verilmedi.'; return; }
        const pr=currentPair();
        const sA = sim(pr.a, hyp);
        const sB = sim(pr.b, hyp);
        const best = Math.max(sA,sB);
        const target = (sA>=sB) ? pr.a : pr.b;
        pRes.className = best>80?'alert alert-success':(best>55?'alert alert-info':'alert alert-error');
        pRes.textContent = `Hedef: “${target}” · Sizin: “${hyp}” · Skor: %${best}`;
      }); }
      try{ __pronPairs = await loadPronPairs(learnLang); fillPronOptions(); }catch{}
      }catch{}

    })();
  </script>
</body>
</html>


