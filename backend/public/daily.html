<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Günlük Görev · KonusKonusabilirsen</title>
  <link rel="stylesheet" href="/styles.css?v=2" />
  <script>
    try{
      const token = localStorage.getItem('hk_token');
      if (!token){
        const redirect = encodeURIComponent('/daily.html');
        window.location.replace(`/?auth=1&redirect=${redirect}`);
      }
    }catch{}
  </script>
</head>
<body>
  <script src="/header.js"></script>

  <main class="container" style="padding:24px 0 40px; max-width:900px;">
    <div id="toast" class="toast">Seri +1! Tebrikler 🎉</div>
    <!-- Top summary -->
    <div class="card" style="padding:16px; margin-bottom:12px;">
      <div class="row" style="justify-content:space-between; align-items:center; gap:8px;">
        <div class="row" style="gap:8px; align-items:center;">
          <span class="pill" id="sumStreak">Seri: 0</span>
          <span class="pill" id="sumReset">Yenilenmeye: --</span>
        </div>
        <div class="row" style="gap:10px; align-items:center;">
          <div style="position:relative; width:74px; height:74px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg); width:74px; height:74px;">
              <path d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="#1b2442" stroke-width="4"/>
              <path id="goalArc" d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="url(#g)" stroke-width="4" stroke-dasharray="0,100"/>
              <defs>
                <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%" stop-color="var(--brand)"/>
                  <stop offset="100%" stop-color="var(--neon)"/>
                </linearGradient>
              </defs>
            </svg>
            <div id="goalPct" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:700;">0%</div>
          </div>
          <div>
            <div class="subtle">Günlük hedef</div>
            <div id="goalText" style="font-weight:700;">0/10 dk</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's challenge -->
    <div id="daily" class="card challenge-card" style="padding:16px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Günlük Konuşma Görevi</h2>
        <div class="row" style="gap:8px;">
          <a id="dailyStart" href="/realtime.html" class="btn btn-primary">Görevi Başlat</a>
          <button id="dailyDone" class="btn btn-secondary" type="button" style="display:none;">Tamamlandı</button>
          <button id="dailyShuffle" class="btn btn-secondary" type="button">Değiştir</button>
        </div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
        <span class="pill" id="dailyLevel">Seviye: -</span>
        <span class="pill" id="dailyTag">-</span>
      </div>
      <p class="subtle" id="dailyDesc" style="margin:8px 0 0;">Bugün için öneri yükleniyor...</p>
    </div>

    <!-- Tip of the day -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Bugünün İpucu</h3>
      <p id="tipText" class="subtle" style="margin:0;">Yükleniyor...</p>
    </div>

    <!-- Quick Warmup: Shadowing & Pronunciation -->
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px;">
      <div class="card" style="padding:16px;">
        <h3 style="margin:0 0 6px;">Hızlı Shadowing</h3>
        <div class="row" style="gap:8px;">
          <select id="dqShSentence" style="flex:1; min-width:200px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);">
            <option>Merhaba, bugün nasılsın?</option>
            <option>Kendimi geliştirmek için her gün pratik yapıyorum.</option>
            <option>Randevum saat üçte, geç kalmak istemiyorum.</option>
          </select>
          <button id="dqShPlay" class="btn btn-secondary" type="button">Dinle</button>
          <button id="dqShRecord" class="btn btn-primary" type="button">Tekrar Et</button>
        </div>
        <div id="dqShResult" class="alert alert-info" style="margin-top:10px; display:none;"></div>
      </div>
      <div class="card" style="padding:16px;">
        <h3 style="margin:0 0 6px;">Telaffuz Koçu (Mini)</h3>
        <div class="row" style="gap:8px;">
          <select id="dqPcPair" style="flex:1; min-width:200px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);">
            <option value="p-b">p vs b</option>
            <option value="k-g">k vs g</option>
            <option value="s-z">s vs z</option>
          </select>
          <button id="dqPcPlay" class="btn btn-secondary" type="button">Örnek</button>
          <button id="dqPcRecord" class="btn btn-primary" type="button">Tekrar Et</button>
        </div>
        <div id="dqPcResult" class="alert alert-info" style="margin-top:10px; display:none;"></div>
      </div>
    </div>

    <!-- Mini streak calendar -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Son 7 Gün</h3>
      <div id="miniCal" class="row" style="gap:8px;">
      </div>
    </div>

    <!-- Journal -->
    <div class="card" style="padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 6px;">Bugün Öğrendiklerim</h3>
      <textarea id="journalInput" placeholder="Kısa notlar..." style="width:100%; min-height:100px; padding:10px 12px; border-radius:10px; background:#0b1022; border:1px solid #1b2442; color:var(--text);"></textarea>
      <div class="row" style="margin-top:8px; gap:8px; align-items:center;">
        <button id="journalSave" class="btn btn-secondary" type="button">Kaydet</button>
        <small id="journalMsg" class="subtle"></small>
      </div>
    </div>
  </main>

  <script src="/config.js"></script>
  <script src="/site.js" type="module"></script>
  <script src="/footer.js"></script>
  <script>
    // After site.js populates scenario & level, check completion and wire complete button + fill summary/tip/calendar/journal
    (async () => {
      try{
        const token = localStorage.getItem('hk_token');
        if (!token) return;
        const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/status`, { headers:{ Authorization: `Bearer ${token}` } });
        const j = await r.json();
        const doneBtn = document.getElementById('dailyDone');
        if (j && j.completed){
          if (doneBtn){ doneBtn.style.display='inline-flex'; doneBtn.disabled=true; doneBtn.textContent='Bugün Tamamlandı'; }
          const start = document.getElementById('dailyStart'); if (start){ start.classList.remove('btn-primary'); start.className='btn btn-secondary'; start.textContent='Tekrar Pratik Et'; }
        } else {
          if (doneBtn){
            doneBtn.style.display='inline-flex';
            doneBtn.addEventListener('click', async () => {
              doneBtn.disabled = true; doneBtn.textContent = 'Kaydediliyor...';
              try{
                // scenario id site.js içinde linke yazılıyor; ordan çekelim
                const href = document.getElementById('dailyStart')?.getAttribute('href') || '/realtime.html';
                const sc = new URLSearchParams(href.split('?')[1]||'').get('scenario');
                const rr = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/complete`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ scenarioId: sc || null, minutes: 10 }) });
                const jj = await rr.json();
                if (rr.ok){
                  doneBtn.textContent = 'Bugün Tamamlandı';
                  // Streak toast
                  try{
                    if (jj?.streakIncremented){
                      const t = document.getElementById('toast');
                      if (t){ t.textContent = `Seri +1! (${jj.streakCount} gün)`; t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); }, 2000); }
                    }
                  }catch{}
                } else { doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert(jj?.error || 'Kaydedilemedi'); }
              }catch(e){ doneBtn.disabled=false; doneBtn.textContent='Tamamlandı'; alert('Bağlantı hatası'); }
            });
          }
        }
      }catch{}
      // Summary band
      try{
        const token = localStorage.getItem('hk_token');
        if (token){
          const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/daily/status`, { headers:{ Authorization: `Bearer ${token}` } });
          const j = await r.json();
          const sumStreak = document.getElementById('sumStreak');
          const sumReset = document.getElementById('sumReset');
          const goalText = document.getElementById('goalText');
          const goalArc = document.getElementById('goalArc');
          const goalPct = document.getElementById('goalPct');
          const goal = Number(j.goal || 10);
          // usage for today from /usage
          try{
            const ur = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/usage`, { headers:{ Authorization: `Bearer ${token}` } });
            const uj = await ur.json();
            const used = Number(uj.usedDaily || uj.daily?.used || 0);
            const pct = Math.max(0, Math.min(100, Math.round((used/Math.max(1,goal))*100)));
            if (goalText) goalText.textContent = `${used.toFixed(1)}/${goal} dk`;
            if (goalPct) goalPct.textContent = `${pct}%`;
            if (goalArc) goalArc.setAttribute('stroke-dasharray', `${pct},100`);
          }catch{}
          if (sumStreak) sumStreak.textContent = `Seri: ${j.streak || 0}`;
          try{
            const resetAt = j.resetAt ? new Date(j.resetAt) : null;
            function upd(){
              if (!resetAt) return;
              const diff = Math.max(0, resetAt - new Date());
              const h = String(Math.floor(diff/3600000)).padStart(2,'0');
              const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
              if (sumReset) sumReset.textContent = `Yenilenmeye: ${h}:${m}`;
            }
            upd(); setInterval(upd, 60000);
          }catch{}
        }
      }catch{}

      // Tip of the day
      try{
        const tips = [
          'Cümle sonunda düşen tonlama yerine son kelimeyi net vurgula.',
          'Dolgu sözcükleri (şey, yani) yerine kısa duraksama tercih et.',
          'Uzun cümleyi ikiye böl: netlik ve ritim artar.',
          'Telaffuz: /r/leri belirgin ama abartısız yap.',
          'Vurgu: bilgi veren kelimeye hafif vurgu ekle.'
        ];
        const tip = tips[Math.floor(Math.random()*tips.length)];
        const tipEl = document.getElementById('tipText'); if (tipEl) tipEl.textContent = tip;
      }catch{}

      // Mini calendar using journal keys
      try{
        const mini = document.getElementById('miniCal');
        if (mini){
          const token = localStorage.getItem('hk_token');
          let completedSet = new Set();
          if (token){
            try{
              const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/journal`, { headers:{ Authorization: `Bearer ${token}` } });
              const j = await r.json();
              const items = j.items || {};
              completedSet = new Set(Object.keys(items));
            }catch{}
          }
          mini.innerHTML = '';
          for (let i=6;i>=0;i--){
            const d = new Date(); d.setDate(d.getDate()-i);
            const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
            const key = `${y}-${m}-${dd}`;
            const on = completedSet.has(key);
            const dot = document.createElement('div');
            dot.style.width = '14px'; dot.style.height = '14px'; dot.style.borderRadius = '999px';
            dot.style.border = '1px solid #243055';
            dot.style.background = on ? 'linear-gradient(135deg, var(--brand), var(--neon))' : '#0e1430';
            dot.title = key + (on ? ' ✓' : '');
            mini.appendChild(dot);
          }
        }
      }catch{}

      // Journal save
      try{
        const btn = document.getElementById('journalSave');
        if (btn){
          btn.addEventListener('click', async () => {
            const token = localStorage.getItem('hk_token');
            const note = document.getElementById('journalInput')?.value || '';
            const msg = document.getElementById('journalMsg'); if (msg) msg.textContent = 'Kaydediliyor...';
            try{
              const r = await fetch(`${window.__BACKEND_BASE__ || 'https://api.konuskonusabilirsen.com'}/journal`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ note }) });
              const j = await r.json();
              if (r.ok){ if (msg) msg.textContent='Kaydedildi.'; }
              else { if (msg) msg.textContent = j?.error || 'Hata'; }
            }catch(e){ if (msg) msg.textContent = 'Bağlantı hatası'; }
          });
        }
      }catch{}

      // Quick warmups
      try{
        // Shadowing mini
        const qPlay = document.getElementById('dqShPlay');
        const qRec = document.getElementById('dqShRecord');
        const qSel = document.getElementById('dqShSentence');
        const qRes = document.getElementById('dqShResult');
        function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='tr-TR'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
        async function recognize(ms=3500){ return new Promise((resolve)=>{ try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){resolve(null);return;} const r=new SR(); r.lang='tr-TR'; r.interimResults=false; r.maxAlternatives=1; r.onresult=e=>resolve(e.results[0][0].transcript||''); r.onerror=()=>resolve(null); r.start(); setTimeout(()=>{ try{ r.stop(); }catch{} }, ms); }catch{ resolve(null); } }); }
        function norm(s){ return (s||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,'').replace(/\s+/g,' ').trim(); }
        if (qPlay){ qPlay.addEventListener('click', ()=> speak(qSel.value)); }
        if (qRec){ qRec.addEventListener('click', async ()=>{ qRes.style.display='block'; qRes.className='alert alert-info'; qRes.textContent='Tekrar edin...'; const hyp=await recognize(3800); const ref=norm(qSel.value); const got=norm(hyp||''); const rset=new Set(ref.split(' ')); const gset=new Set(got.split(' ')); let inter=0; rset.forEach(w=>{ if(gset.has(w)) inter++; }); const score=Math.round((inter/(new Set([...rset,...gset]).size||1))*100); qRes.className= score>70?'alert alert-success':(score>40?'alert alert-info':'alert alert-error'); qRes.textContent=`Eşleşme skoru: %${score} — “${got||'—'}”`; }); }

        // Pronunciation mini
        const pPlay = document.getElementById('dqPcPlay');
        const pRec = document.getElementById('dqPcRecord');
        const pSel = document.getElementById('dqPcPair');
        const pRes = document.getElementById('dqPcResult');
        const tips = { 'p-b':['par','bal'], 'k-g':['kapı','gabı'], 's-z':['sarı','zarı'] };
        function current(){ return tips[pSel.value] || tips['p-b']; }
        if (pPlay){ pPlay.addEventListener('click', ()=> speak(current().join(' — '))); }
        function scoreWord(ref, got){ const r=norm(ref), g=norm(got); if(!g) return 0; const rs=new Set(r.split(' ')); const gs=new Set(g.split(' ')); let inter=0; rs.forEach(w=>{ if(gs.has(w)) inter++; }); return Math.round((inter/(new Set([...rs,...gs]).size||1))*100); }
        if (pRec){ pRec.addEventListener('click', async ()=>{ pRes.style.display='block'; pRes.className='alert alert-info'; pRes.textContent='Tekrar edin...'; const hyp=await recognize(3500); const pair=current(); const s1=scoreWord(pair[0], hyp); const s2=scoreWord(pair[1], hyp); const best=Math.max(s1,s2); pRes.className= best>70?'alert alert-success':(best>40?'alert alert-info':'alert alert-error'); pRes.textContent=`Skor: %${best} — “${hyp||'—'}”`; }); }
      }catch{}

    })();
  </script>
</body>
</html>


